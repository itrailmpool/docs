# Установка miningcore пула
На данном этапе предполагается, что все необходимые пулу блокчейн ноды уже развенуты и полностью синхронизированы с сетью блокчейна.

### Шаг 1. Установите необходимые зависимости

Сначала нужно загрузить и установить пакет `packages-microsoft-prod.rpm`. Этот пакет добавляет репозитории Microsoft в системы, основанные на Red Hat Enterprise Linux (RHEL), включая Oracle Linux 8:
```sh
wget https://packages.microsoft.com/config/rhel/8/packages-microsoft-prod.rpm
sudo dnf install -y ./packages-microsoft-prod.rpm
```
После установки пакет можно удалить:
```sh
rm packages-microsoft-prod.rpm
```
Установите остальные зависимости:
```sh
sudo dnf install -y dotnet-sdk-6.0 git cmake make openssl-devel pkgconfig boost-devel libsodium-devel zeromq-devel gcc-c++
```

### Шаг 2. Настройка postgres
> Note: Предполагается, что postgres предаврительно установлен
```sh
sudo -u postgres psql

CREATE ROLE miningcore WITH LOGIN ENCRYPTED PASSWORD 'miningcore';
CREATE DATABASE miningcore OWNER miningcore;
\q
```
Выполнить скрипт для создания структуры БД [createdb.sql](createdb.sql):
```sh
sudo -u postgres psql -d miningcore -f createdb.sql
```
### Шаг 3. Клонируем репозиторий пула:
```sh
cd /home/user/
git clone https://github.com/itrailmpool/miningcore.git
```

### Шаг 4. Собираем пул
```sh
cd miningcore/src/Miningcore
dotnet publish -c Release --framework net6.0 -o ../../build
```
Процесс сборки может занять некоторое время, в зависимости от производительности системы.

### Шаг 5. Настройка конфигурационного файла
Содзадим конфигурационный файл `config.json` в директории ../miningcore/build:
```sh
cd /home/user/miningcore/build/
nano config.json
```
Копируем json конфигурацию и сохраняем файл:
```json
{
  "clusterName": "pull_name",
  "statistics": {
    "updateInterval": 120,
    "gcInterval": 4,
    "cleanupDays": 180                        
  },
  "logging": {
    "level": "info",
    "enableConsoleLog": true,
    "enableConsoleColors": true,
    "logFile": "core.log",
    "apiLogFile": "api.log",
    "logBaseDirectory": "/home/user/log/miningcore",
    "perPoolLogFile": true
  },
  "banning": {
    "manager": "Integrated",
    "banOnJunkReceive": false,
    "banOnInvalidShares": false
  },
  "notifications": {
    "enabled": false,
    "email": {
      "host": "smtp.example.com",
      "port": 587,
      "user": "user",
      "password": "password",
      "fromAddress": "info@yourpool.org",
      "fromName": "pool support"
    },
    "admin": {
      "enabled": false,
      "emailAddress": "user@example.com",
      "notifyBlockFound": true
    }
  },
  "persistence": {
    "postgres": {
      "host": "192.168.100.2",
      "port": 5432,
      "user": "miningcore",
      "password": "miningcore",
      "database": "miningcore"
    }
  },
  "paymentProcessing": {
    "enabled": true,
    "interval": 600,
    "shareRecoveryFile": "recovered-shares.txt"
  },
  "api": {
    "enabled": true,
    "listenAddress": "0.0.0.0",
    "port": 4100,
    "metricsIpWhitelist": [],
    "rateLimiting": {
      "disabled": false,
      "rules": [
        {
          "Endpoint": "*",
          "Period": "1s",
          "Limit": 20
        }
      ],
      "ipWhitelist": []
    }
  },
  "pools": [
    {
      "id": "bitcoin01",
      "enabled": true,
      "coin": "bitcoin",
      "address": "1DnPPFQPrfyNTiHPXhDFyqNnW9T62GEhB1",
      "rewardRecipients": [
        {
          "address": "bc1qwqkhu8jp4p3revxwwxfq9hc4uymgeksjsrmers",
          "percentage": 1.0
        }
      ],
      "blockRefreshInterval": 400,
      "jobRebroadcastTimeout": 10,
      "clientConnectionTimeout": 600,
      "banning": {
        "enabled": false,
        "time": 600,
        "invalidPercent": 50,
        "checkThreshold": 50
      },
      "ports": {
        "3052": {
          "listenAddress": "0.0.0.0",
          "difficulty": 5000,
          "tls": false,
          "tlsPfxFile": "/var/lib/certs/mycert.pfx",
          "varDiff": {
            "minDiff": 1000,
            "maxDiff": null,
            "targetTime": 15,
            "retargetTime": 90,
            "variancePercent": 30,
            "maxDelta": 5000
          }
        }
      },
      "daemons": [
        {
          "host": "127.0.0.1",
          "port": 8332,
          "user": "bitcoin",
          "password": "bitcoin",
          "zmqBlockNotifySocket": "tcp://127.0.0.1:28332"
        }
      ],
      "paymentProcessing": {
        "enabled": true,
        "minimumPayment": 0.01,
        "payoutScheme": "PPLNS",
        "payoutSchemeConfig": {
          "factor": 2.0
        }
      }
    },
    {
      "id": "litecoin01",
      "enabled": true,
      "coin": "litecoin",
      "address": "M8cvPxk1UaV42exJLAQcP7A2uMp9Yk7jRB",
      "rewardRecipients": [
        {
          "address": "M9NTQPQDfmMSPJRWorUfr3CdMHtdKdvfVf",
          "percentage": 0.5
        }
      ],
      "blockRefreshInterval": 400,
      "jobRebroadcastTimeout": 10,
      "clientConnectionTimeout": 600,
      "banning": {
        "enabled": false,
        "time": 600,
        "invalidPercent": 50,
        "checkThreshold": 50
      },
      "ports": {
        "3053": {
          "listenAddress": "0.0.0.0",
          "difficulty": 5000,
          "tls": false,
          "tlsPfxFile": "/var/lib/certs/mycert.pfx",
          "varDiff": {
            "minDiff": 1000,
            "maxDiff": null,
            "targetTime": 15,
            "retargetTime": 90,
            "variancePercent": 30,
            "maxDelta": 5000
          }
        }
      },
      "daemons": [
        {
          "host": "127.0.0.1",
          "port": 9332,
          "user": "litecoin",
          "password": "litecoin",
          "zmqBlockNotifySocket": "tcp://127.0.0.1:29332"
        }
      ],
      "paymentProcessing": {
        "enabled": true,
        "minimumPayment": 0.01,
        "payoutScheme": "PPLNS",
        "payoutSchemeConfig": {
          "factor": 2.0
        }
      }
    }
  ]
}
```

### Шаг 6. Сохраняем и запускаем пул
```sh
./Miningcore -c config.json
```
Для запуска в фоновом режиме выполните:
```sh
nohup ./Miningcore -c config.json &
```

## Описание параметров конфигурационного файла
##### Конфигурационный параметр `clusterName` определяет имя пула (значение будет отображаться в таблице share, столбец source)
##### Конфигурационные параметры для `statistics` определяют настройки обновления и очистки статистики для miningcore:
- `updateInterval` определяет, как часто пул должен обновлять свои статистические данные. Значение задается в секундах.
- `hashrateCalculationWindow` определяет размер окна времени, которое должно быть учтено при вычислении хешрейта. Хешрейт — это скорость, с которой добытчик может выполнить определенное количество вычислений. Значение задается в минутах.
- `gcInterval` определяет, как часто пул должен проводить очистку старой статистики. Значение задается в часах.
- `cleanupDays` определяет, сколько дней статистики должно сохраняться перед тем, как она будет удалена во время очистки. Значение задается в днях.

##### Конфигурационные параметры для `logging` определяют настройки журналирования для miningcore:
- `level` уровень логирования. Значения могут включать в себя "trace", "debug", "info", "warn", и "error". "info" это обычный уровень, который включает в себя основную информацию о действиях программы.
- `enableConsoleLog` определяет, будут ли записи логов выводиться в консоль. Если это значение установлено как true, то логи будут отображаться в консоли.
- `enableConsoleColors` определяет, будут ли цвета использоваться в консольных логах. Это помогает визуально различать разные уровни логов.
- `logFile` имя файла, в котором сохраняются основные логи miningcore.
- `apiLogFile` имя файла, в котором сохраняются логи API.
- `logBaseDirectory` базовая директория, где будут сохраняться все файлы логов.
- `perPoolLogFile` если это значение установлено как true, то для каждого пула будет создан отдельный файл лога. Если false, то все логи пулов будут записываться в общий файл лога.

##### Конфигурационные параметры в секции `banning` предоставляют вам возможность настраивать политику бана в зависимости от того, какие действия вы считаете недопустимыми для узлов или майнеров, подключенных к вашему пулу:
- `manager` указывает, какая система бана будет использоваться. "Integrated" означает, что будет использоваться встроенная система бана.
- `banOnJunkReceive` если этот параметр установлен в true, узлы или майнеры, которые отправляют мусорные данные (нерелевантные, поврежденные или неправильно форматированные данные), будут забанены. Значение false означает, что отправка "мусорных" данных не приведет к бану.
- `banOnInvalidShares` если этот параметр установлен в true, узлы или майнеры, которые отправляют недействительные доли (например, результаты работы, которые не могут быть приняты пулом), будут забанены. Значение false означает, что отправка недействительных долей не приведет к бану.

##### Конфигурационные параметры в секции `notifications` определяют настройки уведомлений для вашего пула:
- `enabled` параметр контролирует, включены ли уведомления в целом. Если он установлен в true, уведомления будут включены.
- `email` блок конфигурации управляет настройками SMTP для отправки уведомлений по электронной почте.
  - `host` имя хоста вашего SMTP-сервера.
  - `port` порт, на котором работает ваш SMTP-сервер.
  - `user` и `password` имя пользователя и пароль для аутентификации на вашем SMTP-сервере.
  - `fromAddress` и `fromName` адрес электронной почты и имя, которые будут отображаться в отправленных уведомлениях.
- `admin` блок конфигурации управляет настройками уведомлений для администратора пула.
  - `enabled` параметр управляет тем, будут ли уведомления отправляться администратору. Если он установлен в true, уведомления будут отправляться.
  - `emailAddress` адрес электронной почты администратора, на который будут отправляться уведомления.
  - `notifyBlockFound` если этот параметр установлен в true, администратор будет получать уведомления о найденных блоках.

##### Конфигурационные параметры в секции `persistence` определяют настройки подключения к базе данных PostgreSQL для Miningcore:
- `host` IP-адрес или доменное имя сервера, на котором запущен PostgreSQL.
- `port` порт, на котором PostgreSQL слушает подключения. По умолчанию PostgreSQL использует порт 5432.
- `user` имя пользователя, которое используется для подключения к серверу PostgreSQL.
- `password` пароль, который используется вместе с именем пользователя для подключения к серверу PostgreSQL.
- `database` имя базы данных, к которой вы хотите подключиться на сервере PostgreSQL.

##### Конфигурационные параметры в секции `paymentProcessing` управляют обработкой выплат в Miningcore:
- `enabled` параметр указывает, включена ли обработка выплат или нет. Если true, Miningcore будет автоматически выплачивать вознаграждения майнерам. Если false, автоматические выплаты будут отключены.
- `interval` параметр указывает интервал в секундах между обработкой выплат. В данном случае каждые 600 секунд (10 минут) Miningcore будет проверять, есть ли какие-либо выплаты для обработки.
- `shareRecoveryFile` если процесс Miningcore неожиданно остановится, он может записать некоторые ненагражденные доли в файл восстановления, который указан в этом параметре. Затем при следующем запуске он может восстановить эти доли из файла и учесть их при следующей обработке выплат. Это помогает обеспечить, что доля каждого майнера в работе будет правильно учтена, даже если произойдет сбой в процессе Miningcore.

##### Конфигурационные параметры в секции `api` относится к настройкам API Miningcore:
- `enabled` параметр указывает, включен ли API. Если true, API будет доступен для взаимодействия.
- `listenAddress` IP-адрес, на котором будет слушать API. В данном случае 0.0.0.0 означает, что API будет доступен со всех сетевых интерфейсов сервера.
- `port` порт, на котором будет слушать API.
- `metricsIpWhitelist` список IP-адресов, которым разрешен доступ к метрикам API. Если список пуст, то доступ открыт для всех.
- `rateLimiting` настройки ограничения скорости для API.
  - `disable` если true, ограничение скорости будет отключено.
  - `rules` список правил для ограничения скорости. Каждое правило определяет:
    - `Endpoint` конкретный конечный пункт API, к которому применяется правило.
    - `Period` период времени, в течение которого применяется лимит (в данном случае, одна секунда).
    - `Limit` максимальное количество запросов, которые можно сделать в течение указанного периода.
- `ipWhitelist` список IP-адресов, которые исключены из ограничения скорости. Если список пуст, то ограничение скорости применяется ко всем.

#### Секция "pools" в конфигурационном файле определяет конфигурации для каждого пула, который вы хотите запустить на вашем сервере Miningcore. Каждый пул описывается своим блоком конфигурации, включающим следующие параметры:

- `id` уникальный идентификатор пула.
- `enabled` определяет, должен ли этот пул запускаться при старте Miningcore.
- `coin` определяет, какой тип криптовалюты будет добываться в этом пуле.
- `address` адрес, на который будут отправляться награды за блоки, найденные в этом пуле. Адрес должен быть предварительно сгенерирован командой [getnewaddress для litecoin](https://github.com/itrailmpool/docs/blob/main/litecoin-node-install.md#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D1%88%D0%BB%D0%B5%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%BE%D0%B2) и [getnewaddress для bitcoin](https://github.com/itrailmpool/docs/blob/main/bitcoin-node-install.md#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D1%88%D0%BB%D0%B5%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%BE%D0%B2).
- `rewardRecipients` cписок адресов, которые будут получать процент от награды за блок.
  - `address` адрес, на который будут отправляться комиссия пула. Адрес должен быть предварительно сгенерирован командой [getnewaddress litecoin](https://github.com/itrailmpool/docs/blob/main/litecoin-node-install.md#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D1%88%D0%BB%D0%B5%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%BE%D0%B2) либо [getnewaddress bitcoin](https://github.com/itrailmpool/docs/blob/main/bitcoin-node-install.md#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D0%BA%D0%BE%D1%88%D0%BB%D0%B5%D0%BA%D0%B0-%D0%B8-%D0%B0%D0%B4%D1%80%D0%B5%D1%81%D0%BE%D0%B2).
  - `percentage` это процент от награды за блок, который будет отправлен на указанный адрес.
- `blockRefreshInterval` количество миллисекунд между запросами на обновление блока.
- `jobRebroadcastTimeout` после этого количества секунд, неразрешенные задания будут повторно транслироваться в пул.
- `clientConnectionTimeout` время в секундах, после которого неактивные клиенты будут отключены.
- `banning` раздел определяет правила для блокировки майнеров, которые отправляют слишком много недопустимых решений.
  - `enabled` если установлено значение true, система банов будет активирована. Если установлено значение false, система банов будет отключена.
  - `time` время (в секундах), на которое будет забанен майнер, если его действия будут считаться недопустимыми.
  - `invalidPercent` процент недействительных решений, принятых от майнера, превышение которого приведет к его бану. Например, если это значение установлено на 50, то майнер будет забанен, если 50% или более его представленных решений оказались недействительными.
  - `checkThreshold` количество принятых решений, которое нужно проверить, прежде чем сделать вывод о том, нарушает ли майнер правила. Например, если это значение установлено на 50, то система банов будет применяться только после того, как майнер представит 50 решений.
- `ports` определяет настройки для stratum портов, которые пул будет слушать для подключения майнеров.
  - `3052` номер порта, который будет использоваться майнерами для подключения к пулу.
  - `listenAddress` IP-адрес, на котором пул будет прослушивать подключения. Значение 0.0.0.0 означает, что пул будет прослушивать подключения со всех доступных сетевых интерфейсов.
  - `difficulty` начальная сложность для майнеров, подключающихся к этому порту.
  - `tls` параметр указывает, будет ли пул использовать TLS для шифрования связи с майнерами.
  - `tlsPfxFile` если TLS включен, этот параметр указывает путь к файлу сертификата в формате PFX.
  - `varDiff` блок параметров для настройки переменной сложности (Variable Difficulty). Это метод, который позволяет пулу автоматически корректировать сложность для каждого майнера в зависимости от его производительности.
    - `minDiff` и `maxDif` задают минимальное и максимальное значение сложности, которые пул будет использовать для майнеров.
    - `targetTime` указывает пулу целевое время (в секундах) между принятыми шарами от каждого майнера.
    - `retargetTime` время (в секундах), через которое пул будет корректировать сложность для каждого майнера.
    - `variancePercent` задает процентное отклонение от целевого времени, которое разрешено перед корректировкой сложности.
    - `maxDelta` задает максимальное изменение сложности, которое пул может сделать за один раз.
- `daemons` список нод блокчейна, которые пул будет использовать для подтверждения транзакций и иного взаимодействия с сетью криптовалюты.
  - `host` IP-адрес, на котором запущен нода блокчейна.
  - `port` номер порта, на котором нода блокчейна принимает RPC-подключения.
  - `user` и `password` имя пользователя и пароль для аутентификации RPC. Это должны быть те же имя пользователя и пароль, которые вы указали в конфигурационном файле ноды (bitcoin.conf, litecoin.conf и т.д.) для параметров rpcuser и rpcpassword.
  - `zmqBlockNotifySocket` адрес ZMQ (ZeroMQ) сокета, который используется для получения уведомлений о новых блоках от ноды блокчейна. Нода отправляет уведомления о каждом новом блоке на этот адрес. Пул Miningcore использует эти уведомления, чтобы быстро узнавать о новых блоках в сети блокчейна и обновлять задания для майнеров. Этот адрес должен соответствовать адресу, который вы указали для параметра zmqpubhashblock в конфигурационном файле ноды (bitcoin.conf, litecoin.conf и т.д.).
- `paymentProcessing` раздел определяет настройки для обработки выплат майнерам.
- `enabled` определяет, будет ли обработка платежей включена или нет. Если этот параметр установлен в true, пул будет выплачивать награды за майнинг участникам пула.
- `minimumPayment` минимальный размер выплаты. Майнеры должны намайнить по крайней мере эту сумму, прежде чем пул произведет выплату.
- `payoutScheme` система распределения наград. В данном случае используется PPLNS (Pay Per Last N Shares), которая выплачивает награды на основе последних N долей, представленных каждым майнером.
- `payoutSchemeConfig` конфигурация для выбранной системы распределения наград. Для PPLNS factor определяет число "N" в PPLNS. То есть, в данном случае, размер окна для расчета наград равен двум кругам (где "круг" это среднее время между обнаружением двух последовательных блоков на пуле).
